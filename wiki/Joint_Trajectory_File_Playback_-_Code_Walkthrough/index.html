<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8"/>
<title>Joint Trajectory File Playback - Code Walkthrough - sdk-wiki</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Joint_Trajectory_File_Playback_-_Code_Walkthrough","wgTitle":"Joint Trajectory File Playback - Code Walkthrough","wgCurRevisionId":4595,"wgRevisionId":4595,"wgArticleId":500,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Joint_Trajectory_File_Playback_-_Code_Walkthrough","wgRelevantArticleId":500,"wgRequestId":"4e10a55ea862a1925bd6f83b","wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":["autoconfirmed"],"wgRestrictionMove":["autoconfirmed"]});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user":"ready","site":"ready","user.options":"ready","user.tokens":"loading","ext.pygments":"ready","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready"});mw.loader.implement("user.tokens@0ppuq4y",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});mw.loader.load(["mediawiki.page.startup","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","skins.cavendishmw-rethinkrobotics"]);});</script>
<link rel="stylesheet" href="/wiki/a/load.php?debug=false&amp;lang=en&amp;modules=ext.pygments%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.sectionAnchor&amp;only=styles&amp;skin=cavendishmw-rethinkrobotics"/>
<script async="" src="/wiki/a/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=cavendishmw-rethinkrobotics"></script>
<meta name="ResourceLoaderDynamicStyles" content=""/>
<link rel="stylesheet" href="/wiki/a/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=cavendishmw-rethinkrobotics"/>
<meta name="generator" content="MediaWiki 1.31.0"/>
<link rel="shortcut icon" href="/favicon.ico"/>
<link rel="search" type="application/opensearchdescription+xml" href="/wiki/a/opensearch_desc.php" title="sdk-wiki (en)"/>
<link rel="EditURI" type="application/rsd+xml" href="http://sdk.rethinkrobotics.com/wiki/a/api.php?action=rsd"/>
<link rel="alternate" type="application/atom+xml" title="sdk-wiki Atom feed" href="/wiki/a/index.php?title=Special:RecentChanges&amp;feed=atom"/>
<!--[if lt IE 9]><script src="/wiki/a/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=cavendishmw-rethinkrobotics&amp;sync=1"></script><![endif]-->
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Joint_Trajectory_File_Playback_-_Code_Walkthrough rootpage-Joint_Trajectory_File_Playback_-_Code_Walkthrough skin-cavendishmw-rethinkrobotics action-view"><div id="container"><!-- start fragment header -->
    <!-- <div id="mozilla-org"><a href="#">Mozilla Skin</a></div> -->
    <div id="header" class="noprint">
        <a name="top" id="contentTop"></a>

        <!-- Logo + site name -->
        <h1>
            <a href="/wiki/Main_Page" style="text-indent: 2em; width: 194px; height: 67px; background: transparent url(/wiki/a/skins/cavendishmw-rethinkrobotics/styles/images/header_logo.png) no-repeat scroll 5px -5px;" title="Visit the main page">&nbsp;</a>        </h1>

	<div id="rr_ActionWrap">
	<!-- Account action links -->
	<div id="accountActions"><a href="/wiki/a/index.php?title=Special:UserLogin&returnto=Joint+Trajectory+File+Playback+-+Code+Walkthrough">Log in</a></div>
        <!-- Search box -->
            <form action="/wiki/a/index.php" id="searchform">
        <label for="searchInput">Search</label>
        <input type='hidden' name="title" value="Special:Search"/>
        <input type="search" name="search" placeholder="Search sdk-wiki" title="Search sdk-wiki [f]" accesskey="f" id="searchInput"/>
        &#160;
        <input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton"/>    </form>
	</div>
    </div> <!-- End header div -->
<!-- end fragment header --><div id="mBody"><!-- start fragment mainContent -->
<!-- start fragment firstHeader -->
<div id="firstHeadingDiv" class="firstHeading">
    <h1 lang="en"><span dir="auto">Joint Trajectory File Playback - Code Walkthrough</span></h1>


        <!-- Content action buttons -->
        <ul><li><a href="#">More</a><ul><li id="ca-viewsource"><a href="/wiki/a/index.php?title=Joint_Trajectory_File_Playback_-_Code_Walkthrough&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li><li id="ca-history"><a href="/wiki/a/index.php?title=Joint_Trajectory_File_Playback_-_Code_Walkthrough&amp;action=history" title="Past revisions of this page [h]" accesskey="h">History</a></li></ul></li><li id="ca-nstab-main" class="selected"><a href="/wiki/Joint_Trajectory_File_Playback_-_Code_Walkthrough" title="View the content page [c]" accesskey="c">Page</a></li></ul>
</div><!-- end fragment firstHeader --><!-- start fragment sidebar -->        <div id="side" class="noprint" > <!-- cavendishmw: s/column-one/side/ -->
            <ul id="nav">
                      <li><span>Navigation</span>
            <ul>
                <li id="n-Getting-Started"><a href="/wiki/Getting_Started">Getting Started</a></li>
                <li id="n-Learning"><a href="/wiki/Learning">Learning</a></li>
                <li id="n-Community"><a href="/wiki/Community">Community</a></li>
                <li id="n-Support"><a href="/wiki/Support">Support</a></li>
            </ul>
        </li>
      <li><span>Links</span>
            <ul class="collapsible-collapsed">
                <li id="n-Forum"><a href="https://groups.google.com/a/rethinkrobotics.com/forum/#!forum/brr-users" rel="nofollow">Forum</a></li>
                <li id="n-Source"><a href="https://github.com/RethinkRobotics" rel="nofollow">Source</a></li>
                <li id="n-Source-API"><a href="http://api.rethinkrobotics.com/" rel="nofollow">Source API</a></li>
            </ul>
        </li>
      <li><span>Tools</span>
            <ul class="collapsible-collapsed">
                <li id="n-All-Pages"><a href="/wiki/Special:AllPages">All Pages</a></li>
                <li id="n-Upload-File"><a href="/wiki/Special:Upload">Upload File</a></li>
                <li id="n-What-Links-Here.3F"><a href="/wiki/Special:WhatLinksHere">What Links Here?</a></li>
            </ul>
        </li>
            </ul> <!-- /nav -->
        </div> <!-- /side -->
<!-- end fragment sidebar -->
<div id="mainContent"> <!-- cavendishmw: s/column-content/mainContent/ -->
    
  <div id="bodyContent" class="mw-body">
    <div id="siteSub">From sdk-wiki</div>
    <div id="contentSub"></div>
    <div id="jump-to-nav" class="mw-jump">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>
    
  <!-- start content -->
  <div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div style="padding:5px; border:1px solid #ffcc00; background:#FFFDDF; margin-bottom:0.2em; Font-size:140%;"><a href="/wiki/Joint_Trajectory_Playback_Example" title="Joint Trajectory Playback Example"><img alt="Back.png" src="/wiki/a/images/b/b9/Back.png" width="29" height="20" /></a> <a href="/wiki/Joint_Trajectory_Playback_Example" title="Joint Trajectory Playback Example">Joint Trajectory Playback Example</a></div>
<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>This example demonstrates the usage of the Joint Trajectory Action Server to command raw joint position commands. The <code>main()</code> creates and instance of the <code>Trajectory</code> class and calls the <code>parse_file()</code> method. This method is responsible for parsing the input file and packing them as Request message for the <code>Joint Trajectory Action server</code>. The <code>start()</code> method is then called, which sends the Request messages to the action server. Finally, <code>wait()</code> is then called, which verifies if the trajectory execution was successful.&lt; /br&gt;
<b>Action Servers -</b>robot/limb/left/follow_joint_trajectory, robot/limb/right/follow_joint_trajectory.
</p>
<h2><span class="mw-headline" id="Code_Walkthrough">Code Walkthrough</span></h2>
<p>Now, let's break down the code.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">33 </span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="lineno">34 </span><span class="kn">import</span> <span class="nn">operator</span>
<span class="lineno">35 </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno">36 </span>
<span class="lineno">37 </span><span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect</span>
<span class="lineno">38 </span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="lineno">39 </span><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="lineno">40 </span>
<span class="lineno">41 </span><span class="kn">import</span> <span class="nn">rospy</span>
<span class="lineno">42 </span>
<span class="lineno">43 </span><span class="kn">import</span> <span class="nn">actionlib</span>
<span class="lineno">44 </span>
<span class="lineno">45 </span><span class="kn">from</span> <span class="nn">control_msgs.msg</span> <span class="kn">import</span> <span class="p">(</span>
<span class="lineno">46 </span>    <span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
<span class="lineno">47 </span>    <span class="n">FollowJointTrajectoryGoal</span><span class="p">,</span>
<span class="lineno">48 </span><span class="p">)</span>
<span class="lineno">49 </span><span class="kn">from</span> <span class="nn">trajectory_msgs.msg</span> <span class="kn">import</span> <span class="p">(</span>
<span class="lineno">50 </span>    <span class="n">JointTrajectoryPoint</span><span class="p">,</span>
<span class="lineno">51 </span><span class="p">)</span>
<span class="lineno">52 </span>
<span class="lineno">53 </span><span class="kn">import</span> <span class="nn">baxter_interface</span>
<span class="lineno">54 </span>
<span class="lineno">55 </span><span class="kn">from</span> <span class="nn">baxter_interface</span> <span class="kn">import</span> <span class="n">CHECK_VERSION</span>
</pre></div>
<p>This imports the baxter interface for accessing the limb and the gripper class. The <code>actionlib</code> is imported to use its <code>Action Server</code> class.The <code>CHECK_VERSION</code> is imported to check if the software running on the robot would be compatible with this local version. It is not necessary to check the version in custom programs.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">58 </span><span class="k">class</span> <span class="nc">Trajectory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="lineno">59 </span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">60 </span>        <span class="c1">#create our action server clients</span>
<span class="lineno">61 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span>
<span class="lineno">62 </span>            <span class="s1">&#39;robot/limb/left/follow_joint_trajectory&#39;</span><span class="p">,</span>
<span class="lineno">63 </span>            <span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
<span class="lineno">64 </span>        <span class="p">)</span>
<span class="lineno">65 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span> <span class="o">=</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span>
<span class="lineno">66 </span>            <span class="s1">&#39;robot/limb/right/follow_joint_trajectory&#39;</span><span class="p">,</span>
<span class="lineno">67 </span>            <span class="n">FollowJointTrajectoryAction</span><span class="p">,</span>
<span class="lineno">68 </span>        <span class="p">)</span>
<span class="lineno">69 </span>
<span class="lineno">70 </span>        <span class="c1">#verify joint trajectory action servers are available</span>
<span class="lineno">71 </span>        <span class="n">l_server_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>
<span class="lineno">72 </span>        <span class="n">r_server_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">10.0</span><span class="p">))</span>
<span class="lineno">73 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">l_server_up</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r_server_up</span><span class="p">:</span>
<span class="lineno">74 </span>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Action server not available.&quot;</span>
<span class="lineno">75 </span>                   <span class="s2">&quot; Verify action server availability.&quot;</span><span class="p">)</span>
<span class="lineno">76 </span>            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">77 </span>            <span class="n">rospy</span><span class="o">.</span><span class="n">signal_shutdown</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">78 </span>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>Action server clients for the left and right limbs are created. The existence of action servers for both the limbs are checked with a timeout of 10 seconds. If they are not available, a shutdown signal is sent and the program exits.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">79 </span>        <span class="c1">#create our goal request</span>
<span class="lineno">80 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_l_goal</span> <span class="o">=</span> <span class="n">FollowJointTrajectoryGoal</span><span class="p">()</span>
<span class="lineno">81 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span> <span class="o">=</span> <span class="n">FollowJointTrajectoryGoal</span><span class="p">()</span>
<span class="lineno">82 </span>
<span class="lineno">83 </span>        <span class="c1">#limb interface - current angles needed for start move</span>
<span class="lineno">84 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_l_arm</span> <span class="o">=</span> <span class="n">baxter_interface</span><span class="o">.</span><span class="n">Limb</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="lineno">85 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_r_arm</span> <span class="o">=</span> <span class="n">baxter_interface</span><span class="o">.</span><span class="n">Limb</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="lineno">86 </span>
<span class="lineno">87 </span>        <span class="c1">#gripper interface - for gripper command playback</span>
<span class="lineno">88 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span> <span class="o">=</span> <span class="n">baxter_interface</span><span class="o">.</span><span class="n">Gripper</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">CHECK_VERSION</span><span class="p">)</span>
<span class="lineno">89 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span> <span class="o">=</span> <span class="n">baxter_interface</span><span class="o">.</span><span class="n">Gripper</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">CHECK_VERSION</span><span class="p">)</span>
</pre></div>
<p>The request message that will hold the goal positions for both the limbs' action servers are created. The current joint and gripper positions are also captured.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno"> 92 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<span class="lineno"> 93 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="lineno"> 94 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">error</span><span class="p">():</span>
<span class="lineno"> 95 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="lineno"> 96 </span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">calibrated</span><span class="p">()</span> <span class="ow">and</span>
<span class="lineno"> 97 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;custom&#39;</span><span class="p">):</span>
<span class="lineno"> 98 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">calibrate</span><span class="p">()</span>
<span class="lineno"> 99 </span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">calibrated</span><span class="p">()</span> <span class="ow">and</span>
<span class="lineno">100 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;custom&#39;</span><span class="p">):</span>
<span class="lineno">101 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">calibrate</span><span class="p">()</span>
</pre></div>
<p>The <code>error()</code> method returns whether or not the gripper is in an error state. The possible cause of errors might be over/under-voltage, over/under-current, motor faults, etc. The calibrated() method returns a boolean, true if the gripper is already calibrated, while <code>calibrate()</code> performs the actual calibration of the grippers. <code>type()</code> returns the type of the gripper (custom, electric, etc). The calibration check is skipped if the gripper is a custom gripper. 
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">103 </span>        <span class="c1">#gripper goal trajectories</span>
<span class="lineno">104 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_l_grip</span> <span class="o">=</span> <span class="n">FollowJointTrajectoryGoal</span><span class="p">()</span>
<span class="lineno">105 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_r_grip</span> <span class="o">=</span> <span class="n">FollowJointTrajectoryGoal</span><span class="p">()</span>
<span class="lineno">106 </span>
<span class="lineno">107 </span>        <span class="c1">#param namespace</span>
<span class="lineno">108 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_param_ns</span> <span class="o">=</span> <span class="s1">&#39;/rsdk_joint_trajectory_action_server/&#39;</span>
<span class="lineno">109 </span>
<span class="lineno">110 </span>        <span class="c1">#gripper control rate</span>
<span class="lineno">111 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_rate</span> <span class="o">=</span> <span class="mf">20.0</span>  <span class="c1"># Hz</span>
</pre></div>
<p>The request message that will hold the goal positions for both the grippers are created. The namespace is modified and the grippers' control rates are modified.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">113 </span>    <span class="k">def</span> <span class="nf">_execute_gripper_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">114 </span>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
<span class="lineno">115 </span>        <span class="n">r_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_grip</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span>
<span class="lineno">116 </span>        <span class="n">l_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_grip</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span>
<span class="lineno">117 </span>        <span class="n">pnt_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">pnt</span><span class="o">.</span><span class="n">time_from_start</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span> <span class="k">for</span> <span class="n">pnt</span> <span class="ow">in</span> <span class="n">r_cmd</span><span class="p">]</span>
<span class="lineno">118 </span>        <span class="n">end_time</span> <span class="o">=</span> <span class="n">pnt_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno">119 </span>        <span class="n">rate</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Rate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gripper_rate</span><span class="p">)</span>
<span class="lineno">120 </span>        <span class="n">now_from_start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</pre></div>
<p>The <code>r_cmd</code> and <code>l_cmd</code> variables holds the grippers' positions that were parsed from the file. The corresponding time stamps are read into <code>pnt_times</code> variable.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">121 </span>        <span class="k">while</span><span class="p">(</span><span class="n">now_from_start</span> <span class="o">&lt;</span> <span class="n">end_time</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gripper_rate</span><span class="p">)</span> <span class="ow">and</span>
<span class="lineno">122 </span>              <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()):</span>
<span class="lineno">123 </span>            <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="p">(</span><span class="n">pnt_times</span><span class="p">,</span> <span class="n">now_from_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="lineno">124 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
<span class="lineno">125 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_gripper</span><span class="o">.</span><span class="n">command_position</span><span class="p">(</span><span class="n">r_cmd</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno">126 </span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
<span class="lineno">127 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">_l_gripper</span><span class="o">.</span><span class="n">command_position</span><span class="p">(</span><span class="n">l_cmd</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno">128 </span>            <span class="n">rate</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
<span class="lineno">129 </span>            <span class="n">now_from_start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</pre></div>
<p><code>idx</code> holds the index of the timestamp from the file, relative to the current one. It is important to note that the velocities at which the Joint Positions were traversed are preserved during the playback. The corresponding grippers' positions are then commanded to the action server.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">131 </span>    <span class="k">def</span> <span class="nf">_clean_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">):</span>
<span class="lineno">132 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">133 </span><span class="sd">        Cleans a single line of recorded joint positions</span>
<span class="lineno">134 </span>
<span class="lineno">135 </span><span class="sd">        @param line: the line described in a list to process</span>
<span class="lineno">136 </span><span class="sd">        @param joint_names: joint name keys</span>
<span class="lineno">137 </span>
<span class="lineno">138 </span><span class="sd">        @return command: returns dictionary {joint: value} of valid commands</span>
<span class="lineno">139 </span><span class="sd">        @return line: returns list of current line values stripped of commas</span>
<span class="lineno">140 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">141 </span>        <span class="k">def</span> <span class="nf">try_float</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="lineno">142 </span>            <span class="k">try</span><span class="p">:</span>
<span class="lineno">143 </span>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="lineno">144 </span>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="lineno">145 </span>                <span class="k">return</span> <span class="bp">None</span>
<span class="lineno">146 </span>        <span class="c1">#convert the line of strings to a float or None</span>
<span class="lineno">147 </span>        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">try_float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
<span class="lineno">148 </span>        <span class="c1">#zip the values with the joint names</span>
<span class="lineno">149 </span>        <span class="n">combined</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">joint_names</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="lineno">150 </span>        <span class="c1">#take out any tuples that have a none value</span>
<span class="lineno">151 </span>        <span class="n">cleaned</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">combined</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
<span class="lineno">152 </span>        <span class="c1">#convert it to a dictionary with only valid commands</span>
<span class="lineno">153 </span>        <span class="n">command</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span>
<span class="lineno">154 </span>        <span class="k">return</span> <span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">line</span><span class="p">,)</span>
</pre></div>
<p>This <code>try_float()</code> function replaces the contents of the variable passed with float and <code>none</code> values. Then, a tuple is constructed by zipping the names passed with the values from the variable <code>line</code>. This may contain valid values as well as <code>none</code> values . After removing the <code>none</code> values, a dictionary is constructed. This dictionary is then parsed to create valid Joint commands. 
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">156 </span>    <span class="k">def</span> <span class="nf">_add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">side</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="lineno">157 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">158 </span><span class="sd">        Appends trajectory with new point</span>
<span class="lineno">159 </span>
<span class="lineno">160 </span><span class="sd">        @param positions: joint positions</span>
<span class="lineno">161 </span><span class="sd">        @param side: limb to command point</span>
<span class="lineno">162 </span><span class="sd">        @param time: time from start for point in seconds</span>
<span class="lineno">163 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">164 </span>        <span class="c1">#creates a point in trajectory with time_from_start and positions</span>
<span class="lineno">165 </span>        <span class="n">point</span> <span class="o">=</span> <span class="n">JointTrajectoryPoint</span><span class="p">()</span>
<span class="lineno">166 </span>        <span class="n">point</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
<span class="lineno">167 </span>        <span class="n">point</span><span class="o">.</span><span class="n">time_from_start</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
<span class="lineno">168 </span>        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">:</span>
<span class="lineno">169 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
<span class="lineno">170 </span>        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span>
<span class="lineno">171 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
<span class="lineno">172 </span>        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;left_gripper&#39;</span><span class="p">:</span>
<span class="lineno">173 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_l_grip</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
<span class="lineno">174 </span>        <span class="k">elif</span> <span class="n">side</span> <span class="o">==</span> <span class="s1">&#39;right_gripper&#39;</span><span class="p">:</span>
<span class="lineno">175 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_r_grip</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
</pre></div>
<p>This method creates a request message of the <code>JointTrajectoryPoint</code> type and appends the goal position based on the side of the limb/gripper that is requesting. It compiles a list of Joint Positions as the trajectory.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">177 </span>    <span class="k">def</span> <span class="nf">parse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="lineno">178 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">179 </span><span class="sd">        Parses input file into FollowJointTrajectoryGoal format</span>
<span class="lineno">180 </span>
<span class="lineno">181 </span><span class="sd">        @param filename: input filename</span>
<span class="lineno">182 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">183 </span>        <span class="c1">#open recorded file</span>
<span class="lineno">184 </span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="lineno">185 </span>            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="lineno">186 </span>        <span class="c1">#read joint names specified in file</span>
<span class="lineno">187 </span>        <span class="n">joint_names</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="lineno">188 </span>        <span class="c1">#parse joint names for the left and right limbs</span>
<span class="lineno">189 </span>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">joint_names</span><span class="p">:</span>
<span class="lineno">190 </span>            <span class="k">if</span> <span class="s1">&#39;left&#39;</span> <span class="o">==</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
<span class="lineno">191 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">_l_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="lineno">192 </span>            <span class="k">elif</span> <span class="s1">&#39;right&#39;</span> <span class="o">==</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
<span class="lineno">193 </span>                <span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
<p>The lines are split into a list with ',' as the delimiter to extract the joint names. The arm of the current joint, found by stripping the "_&lt;joint&gt;" (last three characters) from the joint_name, is checked and stored.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">195 </span>        <span class="k">def</span> <span class="nf">find_start_offset</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
<span class="lineno">196 </span>            <span class="c1">#create empty lists</span>
<span class="lineno">197 </span>            <span class="n">cur</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">198 </span>            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">199 </span>            <span class="n">dflt_vel</span> <span class="o">=</span> <span class="p">[]</span>
<span class="lineno">200 </span>            <span class="n">vel_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_param_ns</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_default_velocity&quot;</span>
<span class="lineno">201 </span>            <span class="c1">#for all joints find our current and first commanded position</span>
<span class="lineno">202 </span>            <span class="c1">#reading default velocities from the parameter server if specified</span>
<span class="lineno">203 </span>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">joint_names</span><span class="p">:</span>
<span class="lineno">204 </span>                <span class="k">if</span> <span class="s1">&#39;left&#39;</span> <span class="o">==</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
<span class="lineno">205 </span>                    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<span class="lineno">206 </span>                    <span class="n">cur</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_arm</span><span class="o">.</span><span class="n">joint_angle</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="lineno">207 </span>                    <span class="n">prm</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">vel_param</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
<span class="lineno">208 </span>                    <span class="n">dflt_vel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span>
<span class="lineno">209 </span>                <span class="k">elif</span> <span class="s1">&#39;right&#39;</span> <span class="o">==</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
<span class="lineno">210 </span>                    <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
<span class="lineno">211 </span>                    <span class="n">cur</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_arm</span><span class="o">.</span><span class="n">joint_angle</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="lineno">212 </span>                    <span class="n">prm</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="n">vel_param</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
<span class="lineno">213 </span>                    <span class="n">dflt_vel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prm</span><span class="p">)</span>
<span class="lineno">214 </span>            <span class="n">diffs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cur</span><span class="p">)</span>
<span class="lineno">215 </span>            <span class="n">diffs</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span> <span class="n">diffs</span><span class="p">)</span>
<span class="lineno">216 </span>            <span class="c1">#determine the largest time offset necessary across all joints</span>
<span class="lineno">217 </span>            <span class="n">offset</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">div</span><span class="p">,</span> <span class="n">diffs</span><span class="p">,</span> <span class="n">dflt_vel</span><span class="p">))</span>
<span class="lineno">218 </span>            <span class="k">return</span> <span class="n">offset</span>
</pre></div>
<p>The first commanded position and the current position for all the joints are captured. The default values that were loaded into the param server are read. The largest time offset necessary across all the joints is calculated.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">220 </span>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
<span class="lineno">221 </span>            <span class="c1">#clean each line of file</span>
<span class="lineno">222 </span>            <span class="n">cmd</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clean_line</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">)</span>
<span class="lineno">223 </span>            <span class="c1">#find allowable time offset for move to start position</span>
<span class="lineno">224 </span>            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">225 </span>                <span class="n">start_offset</span> <span class="o">=</span> <span class="n">find_start_offset</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="lineno">226 </span>            <span class="c1">#add a point for this set of commands with recorded time</span>
<span class="lineno">227 </span>            <span class="n">cur_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="n">jnt</span><span class="p">]</span> <span class="k">for</span> <span class="n">jnt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_l_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="p">]</span>
<span class="lineno">228 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_offset</span><span class="p">)</span>
<span class="lineno">229 </span>            <span class="n">cur_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="n">jnt</span><span class="p">]</span> <span class="k">for</span> <span class="n">jnt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">joint_names</span><span class="p">]</span>
<span class="lineno">230 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_offset</span><span class="p">)</span>
<span class="lineno">231 </span>            <span class="n">cur_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;left_gripper&#39;</span><span class="p">]]</span>
<span class="lineno">232 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="s1">&#39;left_gripper&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_offset</span><span class="p">)</span>
<span class="lineno">233 </span>            <span class="n">cur_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;right_gripper&#39;</span><span class="p">]]</span>
<span class="lineno">234 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_add_point</span><span class="p">(</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="s1">&#39;right_gripper&#39;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">start_offset</span><span class="p">)</span>
</pre></div>
<p>The non-float values are cleaned and a dictionary of valid Joint Commands is returned in the <code>_clean_line()</code> function as explained above. The time offset for move to start position is also calculated. The parsed set of recorded commands along with their recorded time is added to the goal list.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">236 </span>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">237 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">238 </span><span class="sd">        Sends FollowJointTrajectoryAction request</span>
<span class="lineno">239 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">240 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_l_goal</span><span class="p">)</span>
<span class="lineno">241 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span><span class="p">)</span>
<span class="lineno">242 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">_execute_gripper_commands</span><span class="p">()</span>
</pre></div>
<p>This function sends the <code>FollowJointTrajectoryAction</code> request message which includes the recorded positions and their corresponding time, to the Joint Trajectory Action Server.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">244 </span>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">245 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">246 </span><span class="sd">        Preempts trajectory execution by sending cancel goals</span>
<span class="lineno">247 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">248 </span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">gh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
<span class="lineno">249 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">GoalStatus</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">):</span>
<span class="lineno">250 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
<span class="lineno">251 </span>
<span class="lineno">252 </span>        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">gh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
<span class="lineno">253 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span> <span class="o">==</span> <span class="n">actionlib</span><span class="o">.</span><span class="n">GoalStatus</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">):</span>
<span class="lineno">254 </span>            <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">cancel_goal</span><span class="p">()</span>
<span class="lineno">255 </span>
<span class="lineno">256 </span>        <span class="c1">#delay to allow for terminating handshake</span>
<span class="lineno">257 </span>        <span class="n">rospy</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
<p>The Trajectory execution is stopped by sending cancel goals to the <code>Joint trajectory action server</code>.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">259 </span>    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">260 </span>        <span class="sd">&quot;&quot;&quot;</span>
<span class="lineno">261 </span><span class="sd">        Waits for and verifies trajectory execution result</span>
<span class="lineno">262 </span><span class="sd">        &quot;&quot;&quot;</span>
<span class="lineno">263 </span>        <span class="c1">#create a timeout for our trajectory execution</span>
<span class="lineno">264 </span>        <span class="c1">#total time trajectory expected for trajectory execution plus a buffer</span>
<span class="lineno">265 </span>        <span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_goal</span><span class="o">.</span><span class="n">trajectory</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time_from_start</span><span class="o">.</span><span class="n">to_sec</span><span class="p">()</span>
<span class="lineno">266 </span>        <span class="n">time_buffer</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_param_ns</span> <span class="o">+</span> <span class="s1">&#39;goal_time&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.5</span>
<span class="lineno">267 </span>        <span class="n">timeout</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">last_time</span> <span class="o">+</span> <span class="n">time_buffer</span><span class="p">)</span>
<span class="lineno">268 </span>
<span class="lineno">269 </span>        <span class="n">l_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="lineno">270 </span>        <span class="n">r_finish</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="lineno">271 </span>        <span class="n">l_result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_left_client</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">272 </span>        <span class="n">r_result</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_right_client</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span><span class="o">.</span><span class="n">error_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="lineno">273 </span>
<span class="lineno">274 </span>        <span class="c1">#verify result</span>
<span class="lineno">275 </span>        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">l_finish</span><span class="p">,</span> <span class="n">r_finish</span><span class="p">,</span> <span class="n">l_result</span><span class="p">,</span> <span class="n">r_result</span><span class="p">]):</span>
<span class="lineno">276 </span>            <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">277 </span>        <span class="k">else</span><span class="p">:</span>
<span class="lineno">278 </span>            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Trajectory action failed or did not finish before &quot;</span>
<span class="lineno">279 </span>                   <span class="s2">&quot;timeout/interrupt.&quot;</span><span class="p">)</span>
<span class="lineno">280 </span>            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">281 </span>            <span class="k">return</span> <span class="bp">False</span>
</pre></div>
<p>This method waits for the completion of the trajectory execution by <code>Joint trajectory action server<code>.
</code></code></p><code><code><div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">284 </span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="lineno">285 </span>    <span class="sd">&quot;&quot;&quot;RSDK Joint Trajectory Example: File Playback</span>
<span class="lineno">286 </span>
<span class="lineno">287 </span><span class="sd">    Plays back joint positions honoring timestamps recorded</span>
<span class="lineno">288 </span><span class="sd">    via the joint_recorder example.</span>
<span class="lineno">289 </span>
<span class="lineno">290 </span><span class="sd">    Run the joint_recorder.py example first to create a recording</span>
<span class="lineno">291 </span><span class="sd">    file for use with this example. Then make sure to start the</span>
<span class="lineno">292 </span><span class="sd">    joint_trajectory_action_server before running this example.</span>
<span class="lineno">293 </span>
<span class="lineno">294 </span><span class="sd">    This example will use the joint trajectory action server</span>
<span class="lineno">295 </span><span class="sd">    with velocity control to follow the positions and times of</span>
<span class="lineno">296 </span><span class="sd">    the recorded motion, accurately replicating movement speed</span>
<span class="lineno">297 </span><span class="sd">    necessary to hit each trajectory point on time.</span>
<span class="lineno">298 </span><span class="sd">    &quot;&quot;&quot;</span>
<span class="lineno">299 </span>    <span class="n">epilog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="lineno">300 </span><span class="s2">Related examples:</span>
<span class="lineno">301 </span><span class="s2">  joint_recorder.py; joint_position_file_playback.py.</span>
<span class="lineno">302 </span><span class="s2">    &quot;&quot;&quot;</span>
<span class="lineno">303 </span>    <span class="n">arg_fmt</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span>
<span class="lineno">304 </span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">formatter_class</span><span class="o">=</span><span class="n">arg_fmt</span><span class="p">,</span>
<span class="lineno">305 </span>                                     <span class="n">description</span><span class="o">=</span><span class="n">main</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">,</span>
<span class="lineno">306 </span>                                     <span class="n">epilog</span><span class="o">=</span><span class="n">epilog</span><span class="p">)</span>
<span class="lineno">307 </span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="lineno">308 </span>        <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--file&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;PATH&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="lineno">309 </span>        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to input file&#39;</span>
<span class="lineno">310 </span>    <span class="p">)</span>
<span class="lineno">311 </span>    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
<span class="lineno">312 </span>        <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--loops&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="lineno">313 </span>        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of playback loops. 0=infinite.&#39;</span>
<span class="lineno">314 </span>    <span class="p">)</span>
<span class="lineno">315 </span>    <span class="c1"># remove ROS args and filename (sys.arv[0]) for argparse</span>
<span class="lineno">316 </span>    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">myargv</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
</pre></div></code></code><code><code><p>The name source file to read the Joint Position is captured along with the number of times the trajectory has to be looped from the command line.
</p></code></code><code><code><div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="lineno">318 </span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Initializing node... &quot;</span><span class="p">)</span>
<span class="lineno">319 </span>    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s2">&quot;rsdk_joint_trajectory_file_playback&quot;</span><span class="p">)</span>
<span class="lineno">320 </span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Getting robot state... &quot;</span><span class="p">)</span>
<span class="lineno">321 </span>    <span class="n">rs</span> <span class="o">=</span> <span class="n">baxter_interface</span><span class="o">.</span><span class="n">RobotEnable</span><span class="p">(</span><span class="n">CHECK_VERSION</span><span class="p">)</span>
<span class="lineno">322 </span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Enabling robot... &quot;</span><span class="p">)</span>
<span class="lineno">323 </span>    <span class="n">rs</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="lineno">324 </span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Running. Ctrl-c to quit&quot;</span><span class="p">)</span>
<span class="lineno">325 </span>
<span class="lineno">326 </span>    <span class="n">traj</span> <span class="o">=</span> <span class="n">Trajectory</span><span class="p">()</span>
<span class="lineno">327 </span>    <span class="n">traj</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">))</span>
<span class="lineno">328 </span>    <span class="c1">#for safe interrupt handling</span>
<span class="lineno">329 </span>    <span class="n">rospy</span><span class="o">.</span><span class="n">on_shutdown</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
<span class="lineno">330 </span>    <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>
<span class="lineno">331 </span>    <span class="n">loop_cnt</span> <span class="o">=</span> <span class="mi">1</span>
<span class="lineno">332 </span>    <span class="n">loopstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">loops</span><span class="p">)</span>
<span class="lineno">333 </span>    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">loops</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">334 </span>        <span class="n">args</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<span class="lineno">335 </span>        <span class="n">loopstr</span> <span class="o">=</span> <span class="s2">&quot;forever&quot;</span>
<span class="lineno">336 </span>    <span class="k">while</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">loop_cnt</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="o">.</span><span class="n">loops</span>
<span class="lineno">337 </span>           <span class="ow">and</span> <span class="ow">not</span> <span class="n">rospy</span><span class="o">.</span><span class="n">is_shutdown</span><span class="p">()):</span>
<span class="lineno">338 </span>        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Playback loop </span><span class="si">%d</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">loop_cnt</span><span class="p">,</span> <span class="n">loopstr</span><span class="p">,))</span>
<span class="lineno">339 </span>        <span class="n">traj</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="lineno">340 </span>        <span class="n">result</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="lineno">341 </span>        <span class="n">loop_cnt</span> <span class="o">=</span> <span class="n">loop_cnt</span> <span class="o">+</span> <span class="mi">1</span>
<span class="lineno">342 </span>    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Exiting - File Playback Complete&quot;</span><span class="p">)</span>
<span class="lineno">343 </span>
<span class="lineno">344 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="lineno">345 </span>    <span class="n">main</span><span class="p">()</span>
</pre></div></code></code><code><code><p>The node is initialized. An instance of the <code>Trajectory</code> class is created. The <code>parse_file()</code> method is called to extract the recorded Joint Positions and their corresponding timestamps as explained above. The <code>start()</code> method is called to send the <code>FollowJointTrajectory</code> request message to the Joint Trajectory Action server. This loops for the user specified number of times.
</p></code></code>
<!-- 
NewPP limit report
Cached time: 20221005032018
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.075 seconds
Real time usage: 1.932 seconds
Preprocessor visited node count: 66/1000000
Preprocessor generated node count: 386/1000000
Postexpand include size: 214/2097152 bytes
Template argument size: 66/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip postexpand size: 60060/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.878      1 Template:Parent_header
100.00%    0.878      1 -total
-->
</div>
<!-- Saved in parser cache with key wikisdk:pcache:idhash:500-0!canonical and timestamp 20221005032016 and revision id 4595
 -->
</div><div class="printfooter">
Retrieved from "<a dir="ltr" href="http://sdk.rethinkrobotics.com/wiki/a/index.php?title=Joint_Trajectory_File_Playback_-_Code_Walkthrough&amp;oldid=4595">http://sdk.rethinkrobotics.com/wiki/a/index.php?title=Joint_Trajectory_File_Playback_-_Code_Walkthrough&amp;oldid=4595</a>"</div>
  <div id="catlinks" class="catlinks catlinks-allhidden" data-mw="interface"></div>  <!-- end content -->
  
    <div class="visualClear"></div>
</div>
</div> <!-- /mainContent -->
<!-- end fragment mainContent --></div> <!-- /mBody --><div class="visualClear"></div><!-- start fragment footer -->    <div id="footer" role="contentinfo">
        <div id="f-poweredbyico">
                <a href="//www.mediawiki.org/"><img src="/wiki/a/resources/assets/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/wiki/a/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /wiki/a/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"/></a>
            </div>
        <ul id="f-list">
                <li id="copywrite_notice">&copy; 2015 Rethink Robotics. All rights reserved.</li>
                <li id="special_pages"><a href="/wiki/Special:SpecialPages" title="Special:SpecialPages">SpecialPages</a></li>
                <li id="privacy"><a href="/wiki/Sdk-wiki:Privacy_policy" title="Sdk-wiki:Privacy policy">Privacy policy</a></li>
                <li id="about"><a href="/wiki/Sdk-wiki:About" title="Sdk-wiki:About">About sdk-wiki</a></li>
                <li id="disclaimer"><a href="/wiki/Sdk-wiki:General_disclaimer" title="Sdk-wiki:General disclaimer">Disclaimers</a></li>
            </ul>
    </div><!-- end fragment footer --></div><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.075","walltime":"1.932","ppvisitednodes":{"value":66,"limit":1000000},"ppgeneratednodes":{"value":386,"limit":1000000},"postexpandincludesize":{"value":214,"limit":2097152},"templateargumentsize":{"value":66,"limit":2097152},"expansiondepth":{"value":2,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":60060,"limit":5000000},"timingprofile":["100.00%    0.878      1 Template:Parent_header","100.00%    0.878      1 -total"]},"cachereport":{"timestamp":"20221005032018","ttl":86400,"transientcontent":false}}});});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":1994});});</script></body></html>